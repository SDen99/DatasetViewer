import{a as D,t as R,c as ie}from"../chunks/disclose-version.BhQv054m.js";import{v as N,N as te,aj as Oe,K as Le,m as Ne,H as Ae,ah as we,L as We,M as de,O as re,w as q,I as ke,o as ye,J as Pe,as as ae,D as ue,at as Me,au as Ue,av as Fe,a3 as ze,z as ce,aw as Qe,ax as Ve,ag as Be,ay as He,q as Ye,a9 as Ge,ad as qe,ab as $e,az as Ke,G as fe,aA as Xe,aB as Je,l as A,j as x,k,p as J,i as Z,t as z,g as h,h as ve,aC as he,aD as Ze,aE as je,B as me,X as F}from"../chunks/runtime.D9qogIZY.js";import{p as T,i as U,o as et,b as tt}from"../chunks/index-client.v_smRzEr.js";import{i as j}from"../chunks/lifecycle.wKKs0xFd.js";import{e as P,a as H,s as rt,b as $}from"../chunks/store.BKD2mwAi.js";import{w as B}from"../chunks/index.DdDLr5F5.js";let se=null;function K(r,e){return e}function at(r,e,t,a){for(var s=[],l=e.length,n=0;n<l;n++)Ve(e[n].e,s,!0);var p=l>0&&s.length===0&&t!==null;if(p){var m=t.parentNode;Be(m),m.append(t),a.clear(),M(r,e[0].prev,e[l-1].next)}He(s,()=>{for(var o=0;o<l;o++){var v=e[o];p||(a.delete(v.k),M(r,v.prev,v.next)),Ye(v.e,!p)}})}function X(r,e,t,a,s,l=null){var n=r,p={flags:e,items:new Map,first:null};{var m=r;n=N?te(Ge(m)):m.appendChild(Oe())}N&&Le();var o=null,v=!1;Ne(()=>{var i=t(),u=Ae(i)?i:i==null?[]:we(i),c=u.length;if(v&&c===0)return;v=c===0;let f=!1;if(N){var _=n.data===We;_!==(c===0)&&(n=de(),te(n),re(!1),f=!0)}if(N){for(var d=null,w,S=0;S<c;S++){if(q.nodeType===8&&q.data===qe){n=q,f=!0,re(!1);break}var g=u[S],y=a(g,S);w=be(q,p,d,null,g,y,S,s,e),p.items.set(y,w),d=w}c>0&&te(de())}N||st(u,p,n,s,e,a),l!==null&&(c===0?o?ke(o):o=ye(()=>l(n)):o!==null&&Pe(o,()=>{o=null})),f&&re(!0),t()}),N&&(n=q)}function st(r,e,t,a,s,l){var n=r.length,p=e.items,m=e.first,o=m,v,i=null,u=[],c=[],f,_,d,w;for(w=0;w<n;w+=1){if(f=r[w],_=l(f,w),d=p.get(_),d===void 0){var S=o?o.e.nodes_start:t;i=be(S,e,i,i===null?e.first:i.next,f,_,w,a,s),p.set(_,i),u=[],c=[],o=i.next;continue}if(nt(d,f,w),d.e.f&ae&&ke(d.e),d!==o){if(v!==void 0&&v.has(d)){if(u.length<c.length){var g=c[0],y;i=g.prev;var W=u[0],I=u[u.length-1];for(y=0;y<u.length;y+=1)ge(u[y],g,t);for(y=0;y<c.length;y+=1)v.delete(c[y]);M(e,W.prev,I.next),M(e,i,W),M(e,I,g),o=g,i=I,w-=1,u=[],c=[]}else v.delete(d),ge(d,o,t),M(e,d.prev,d.next),M(e,d,i===null?e.first:i.next),M(e,i,d),i=d;continue}for(u=[],c=[];o!==null&&o.k!==_;)o.e.f&ae||(v??=new Set).add(o),c.push(o),o=o.next;if(o===null)continue;d=o}u.push(d),i=d,o=d.next}if(o!==null||v!==void 0){for(var L=v===void 0?[]:we(v);o!==null;)o.e.f&ae||L.push(o),o=o.next;var Q=L.length;if(Q>0){var Y=n===0?t:null;at(e,L,Y,p)}}ue.first=e.first&&e.first.e,ue.last=i&&i.e}function nt(r,e,t,a){Me(r.v,e),r.i=t}function be(r,e,t,a,s,l,n,p,m){var o=se;try{var v=(m&Ue)!==0,i=(m&Fe)===0,u=v?i?ze(s):ce(s):s,c=m&Qe?ce(n):n,f={i:c,v:u,k:l,a:null,e:null,prev:t,next:a};return se=f,f.e=ye(()=>p(r,u,c),N),f.e.prev=t&&t.e,f.e.next=a&&a.e,t===null?e.first=f:(t.next=f,t.e.next=f.e),a!==null&&(a.prev=f,a.e.prev=f.e),f}finally{se=o}}function ge(r,e,t){for(var a=r.next?r.next.e.nodes_start:t,s=e?e.e.nodes_start:t,l=r.e.nodes_start;l!==a;){var n=$e(l);s.before(l),l=n}}function M(r,e,t){e===null?r.first=t:(e.next=t,e.e.next=t&&t.e),t!==null&&(t.prev=e,t.e.prev=e&&e.e)}let _e=!1;function ot(){_e||(_e=!0,document.addEventListener("reset",r=>{Promise.resolve().then(()=>{if(!r.defaultPrevented)for(const e of r.target.elements)e.__on_r?.()})},{capture:!0}))}function lt(r){if(N){var e=!1,t=()=>{if(!e){if(e=!0,r.hasAttribute("value")){var a=r.value;ne(r,"value",null),r.value=a}if(r.hasAttribute("checked")){var s=r.checked;ne(r,"checked",null),r.checked=s}}};r.__on_r=t,Ke(t),ot()}}function it(r,e){var t=r.__attributes??={};t.value===(t.value=e)||r.value===e&&(e!==0||r.nodeName!=="PROGRESS")||(r.value=e)}function dt(r,e){var t=r.__attributes??={};t.checked!==(t.checked=e)&&(r.checked=e)}function ne(r,e,t,a){var s=r.__attributes??={};N&&(s[e]=r.getAttribute(e),e==="src"||e==="srcset"||e==="href"&&r.nodeName==="LINK")||s[e]!==(s[e]=t)&&(e==="style"&&"__styles"in r&&(r.__styles={}),e==="loading"&&(r[Xe]=t),t==null?r.removeAttribute(e):typeof t!="string"&&ut(r).includes(e)?r[e]=t:r.setAttribute(e,t))}var pe=new Map;function ut(r){var e=pe.get(r.nodeName);if(e)return e;pe.set(r.nodeName,e=[]);for(var t,a=fe(r),s=Element.prototype;s!==a;){t=Je(a);for(var l in t)t[l].set&&e.push(l);a=fe(a)}return e}function ct(r,e){var t=r.__className,a=ft(e);N&&r.className===a?r.__className=a:(t!==a||N&&r.className!==a)&&(e==null?r.removeAttribute("class"):r.className=a,r.__className=a)}function ft(r){return r??""}var vt=R('<div class="flex items-center justify-center space-x-2"><div class="h-8 w-8 animate-spin rounded-full border-4 border-dashed border-white"></div> <div>Loading...</div></div>'),ht=R('<nav class="w-full bg-blue-500 p-4 text-white"><h1 class="text-2xl font-bold">Upload .sas7bdat Files</h1> <input type="file" accept=".sas7bdat" multiple class="mb-4 rounded border border-gray-300 p-2"> <!></nav>');function mt(r,e){let t=T(e,"handleFileChangeEvent",8),a=T(e,"isLoading",8);var s=ht(),l=A(x(s),2),n=A(l,2);U(n,a,p=>{var m=vt();D(p,m)}),k(s),P("change",l,function(...p){t()?.apply(this,p)}),D(r,s)}var gt=R('<li><button type="button"> </button></li>'),_t=R('<ul class="pl-5"></ul>'),pt=R('<p class="text-gray-500">No datasets to display.</p>'),wt=R('<aside class="w-1/4 bg-white p-4 shadow-md"><h2 class="mb-4 text-xl font-bold">Datasets</h2> <!></aside>');function kt(r,e){J(e,!1);let t=T(e,"datasets",8),a=T(e,"selectedDataset",8),s=T(e,"onSelectDataset",8);j();var l=wt(),n=A(x(l),2);U(n,()=>t().size>0,p=>{var m=_t();X(m,5,()=>Array.from(t().keys()),K,(o,v)=>{var i=gt(),u=x(i),c=x(u,!0);k(u),k(i),z(()=>{ct(u,`cursor-pointer text-gray-700 ${(h(v)===a()?"bg-red-500 text-white":"")??""}`),H(c,h(v))}),P("click",u,()=>s()(h(v))),D(o,i)}),k(m),D(p,m)},p=>{var m=pt();D(p,m)}),k(l),D(r,l),Z()}var yt=R('<th draggable="true" class="cursor-move border-b border-gray-200 bg-gray-100 px-4 py-2 text-left text-sm font-semibold text-gray-700 hover:bg-gray-200"> </th>'),bt=R('<td class="border-b border-gray-200 px-4 py-2 text-sm text-gray-700"> </td>'),xt=R("<tr></tr>"),Dt=R('<table class="min-w-full bg-white"><thead><tr></tr></thead><tbody></tbody></table>');function St(r,e){J(e,!1);let t=T(e,"data",8),a=T(e,"selectedColumns",8),s=T(e,"columnOrder",8),l=T(e,"onReorderColumns",8),n=null;function p(_,d){n=d,_.dataTransfer&&(_.dataTransfer.effectAllowed="move",_.dataTransfer.setData("text/plain",d))}function m(_){_.preventDefault(),_.dataTransfer&&(_.dataTransfer.dropEffect="move")}function o(_,d){if(_.preventDefault(),!n||n===d)return;const w=[...s()],S=w.indexOf(n),g=w.indexOf(d);w.splice(S,1),w.splice(g,0,n),l()(w),n=null}function v(_){return a().has(_)}j();var i=Dt(),u=x(i),c=x(u);X(c,5,s,K,(_,d)=>{var w=ie(),S=ve(w);U(S,()=>v(h(d)),g=>{var y=yt(),W=x(y,!0);k(y),z(()=>H(W,h(d))),P("dragstart",y,I=>p(I,h(d))),P("dragover",y,m),P("drop",y,I=>o(I,h(d))),D(g,y)}),D(_,w)}),k(c),k(u);var f=A(u);X(f,5,()=>t().slice(0,10),K,(_,d)=>{var w=xt();X(w,5,s,K,(S,g)=>{var y=ie(),W=ve(y);U(W,()=>v(h(g)),I=>{var L=bt(),Q=x(L,!0);k(L),z(()=>H(Q,h(d)[h(g)])),D(I,L)}),D(S,y)}),k(w),D(_,w)}),k(f),k(i),D(r,i),Z()}var Et=R('<li draggable="true" class="cursor-move py-1 hover:bg-gray-100"><label class="flex items-center space-x-2"><input type="checkbox"> <span> </span></label></li>'),Tt=R('<aside class="w-1/4 bg-white p-4 shadow-md"><h2 class="mb-4 text-xl font-bold">Variables</h2> <ul class="pl-5"></ul></aside>');function Rt(r,e){J(e,!1);let t=T(e,"selectedColumns",8),a=T(e,"columnOrder",8),s=T(e,"onColumnToggle",8),l=T(e,"onReorderVariables",8),n=null;function p(u,c){n=c,u.dataTransfer&&(u.dataTransfer.effectAllowed="move",u.dataTransfer.setData("text/plain",c))}function m(u){u.preventDefault(),u.dataTransfer&&(u.dataTransfer.dropEffect="move")}function o(u,c){if(u.preventDefault(),!n||n===c)return;const f=[...a()],_=f.indexOf(n),d=f.indexOf(c);f.splice(_,1),f.splice(d,0,n),l()(f),n=null}j();var v=Tt(),i=A(x(v),2);X(i,5,a,K,(u,c)=>{var f=Et(),_=x(f),d=x(_);lt(d),z(()=>dt(d,t().has(h(c))));var w=A(d,2),S=x(w,!0);k(w),k(_),k(f),z(()=>{ne(d,"name",h(c)),it(d,h(c)),H(S,h(c))}),P("change",d,g=>s()(h(c),g.target.checked)),P("dragstart",f,g=>p(g,h(c))),P("dragover",f,m),P("drop",f,g=>o(g,h(c))),D(u,f)}),k(i),k(v),D(r,v),Z()}var Ct=R('<p class="text-sm"> </p>'),It=R('<p class="text-sm"> </p>'),Ot=R('<footer class="flex w-full items-center justify-between bg-gray-800 p-4 text-white"><div><!></div> <div><!></div></footer>');function Lt(r,e){let t=T(e,"uploadTime",8),a=T(e,"numColumns",8),s=T(e,"numRows",8);console.log(t(),a(),s());var l=Ot(),n=x(l),p=x(n);U(p,()=>t()!==void 0,v=>{var i=Ct(),u=x(i);k(i),z(()=>H(u,`Upload and processing time: ${t()??""} seconds`)),D(v,i)}),k(n);var m=A(n,2),o=x(m);U(o,()=>a()!==void 0&&s()!==void 0,v=>{var i=It(),u=x(i);k(i),z(()=>H(u,`Variables: ${a()??""}
				Records: ${s()??""}`)),D(v,i)}),k(m),k(l),D(r,l)}function Nt(r){return`/_app/immutable/workers/${r}`}const At=()=>typeof window<"u"&&"navigator"in window?Math.max(1,navigator.hardwareConcurrency-1):2;function Wt(r){return typeof window>"u"?null:new Pt(r)}class Pt{workers=[];taskQueue=[];maxWorkers;idleTimeout;workerURL;isInitialized=!1;constructor(e,t=3e4){this.maxWorkers=e??At(),this.idleTimeout=t,this.workerURL=Nt("fileProcessor.worker.ts"),console.log("workerURL",this.workerURL),this.isInitialized=!1}async initialize(){this.isInitialized||typeof window>"u"||(setInterval(()=>this.cleanupIdleWorkers(),1e4),this.isInitialized=!0)}createWorker(){return typeof window>"u"?Promise.reject(new Error("Cannot create worker in SSR context")):new Promise((e,t)=>{try{const a=new Worker(this.workerURL,{type:"module"}),s={worker:a,busy:!1,lastUsed:Date.now(),pyodideReady:!1},l=n=>{n.data.type==="PYODIDE_READY"?(s.pyodideReady=!0,a.removeEventListener("message",l),e(s)):n.data.type==="PYODIDE_ERROR"&&(a.removeEventListener("message",l),t(new Error(n.data.error)))};a.addEventListener("message",l),a.addEventListener("error",n=>{console.error("Worker creation error:",n),t(n)}),a.onmessage=n=>this.handleWorkerMessage(n,s)}catch(a){console.error("Failed to create worker:",a),t(a)}})}async getAvailableWorker(){let e=this.workers.find(t=>!t.busy&&t.pyodideReady);if(!e&&this.workers.length<this.maxWorkers)try{e=await this.createWorker(),this.workers.push(e)}catch(t){throw console.error("Failed to create worker:",t),t}return e||new Promise(t=>{const a=setInterval(()=>{const s=this.workers.find(l=>!l.busy&&l.pyodideReady);s&&(clearInterval(a),t(s))},100)})}handleWorkerMessage(e,t){const a=this.taskQueue.find(s=>s.id===e.data.taskId);a&&(e.data.type==="PROCESSING_COMPLETE"?a.resolve(e.data.result):e.data.type==="PROCESSING_ERROR"&&a.reject(new Error(e.data.error)),t.busy=!1,t.lastUsed=Date.now(),this.taskQueue=this.taskQueue.filter(s=>s.id!==e.data.taskId),this.processNextTask())}handleWorkerError(e,t){console.error("Worker error:",e),t.busy=!1}async processNextTask(){if(this.taskQueue.length!==0)try{const e=await this.getAvailableWorker(),t=this.taskQueue[0];e.busy=!0,e.lastUsed=Date.now(),e.worker.postMessage({type:"PROCESS_FILE",taskId:t.id,file:t.file,fileName:t.fileName})}catch(e){console.error("Failed to process task:",e),this.taskQueue[0].reject(e),this.taskQueue.shift()}}cleanupIdleWorkers(){const e=Date.now();this.workers=this.workers.filter(t=>!t.busy&&e-t.lastUsed>this.idleTimeout?(t.worker.terminate(),!1):!0)}async processFile(e,t){return this.isInitialized||await this.initialize(),new Promise((a,s)=>{const l={id:`task_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,file:e,fileName:t,resolve:a,reject:s};this.taskQueue.push(l),this.processNextTask()})}terminate(){this.workers.forEach(e=>{e.worker.terminate()}),this.workers=[],this.taskQueue=[]}}var Mt=R('<main class="flex min-h-screen flex-col bg-gray-100"><!> <div class="flex flex-1 overflow-hidden"><!> <section class="flex-1 overflow-x-auto p-4"><!></section> <!></div> <!></main>');function Ht(r,e){J(e,!1);const t=rt(),a=()=>$(v,"$selectedDatasetStore",t),s=()=>$(o,"$datasetsStore",t),l=()=>$(i,"$isLoadingStore",t),n=()=>$(c,"$selectedColumnsStore",t),p=()=>$(f,"$columnOrderStore",t);let m;const o=B(new Map),v=B(null),i=B(!1),u=B(null),c=B(new Map),f=B(new Map);function _(b){i.set(b)}function d(b){u.set(b)}et(async()=>{m=Wt(),m&&await m.initialize()}),tt(()=>{m?.terminate()});async function w(b){if(!m)return;const E=b.target.files;if(!E||E.length===0)return;_(!0);const C=performance.now(),V=[];try{for(const G of E){if(!G.name.endsWith(".sas7bdat")){console.warn(`Skipping ${G.name} - not a SAS file`);continue}const Ce=await G.arrayBuffer(),Ie=m.processFile(Ce,G.name).then(oe=>(o.update(le=>(le.set(G.name,{...oe,processingTime:(performance.now()-C)/1e3}),le)),oe));V.push(Ie)}await Promise.all(V);const ee=(performance.now()-C)/1e3;d(ee)}catch(ee){console.error("Error processing files:",ee)}finally{_(!1)}}function S(b,O){c.update(E=>{const C=a();if(C){let V=E.get(C)||new Set;O?V.add(b):V.delete(b),E.set(C,V)}return E})}let g=je(null);function y(b){const O=a();O&&f.update(E=>(E.set(O,b),E))}he(()=>(a(),s()),()=>{a()?me(g,s().get(a())):me(g,null)}),he(()=>(h(g),a()),()=>{if(h(g)){const b=a();if(b){const O=Object.keys(h(g).data[0]||{}),E=new Set(O.slice(0,5));c.update(C=>(C.set(b,E),C)),f.update(C=>(C.has(b)||C.set(b,O),C))}}}),Ze(),j();var W=Mt(),I=x(W);mt(I,{handleFileChangeEvent:w,get isLoading(){return l()}});var L=A(I,2),Q=x(L);kt(Q,{get datasets(){return s()},get selectedDataset(){return a()},onSelectDataset:b=>v.set(b)});var Y=A(Q,2),xe=x(Y);U(xe,()=>h(g),b=>{var O=F(()=>a()?n().get(a())??new Set:new Set),E=F(()=>a()?p().get(a())??[]:[]);St(b,{get data(){return h(g).data},get selectedColumns(){return h(O)},get columnOrder(){return h(E)},onReorderColumns:y})}),k(Y);var De=A(Y,2);U(De,()=>h(g),b=>{var O=F(()=>a()?n().get(a())??new Set:new Set),E=F(()=>a()?p().get(a())??[]:[]);Rt(b,{get variables(){return h(g).details.columns},get selectedColumns(){return h(O)},get columnOrder(){return h(E)},onColumnToggle:S,onReorderVariables:y})}),k(L);var Se=A(L,2),Ee=F(()=>h(g)?.processingTime.toFixed(2)),Te=F(()=>h(g)?.details.num_columns),Re=F(()=>h(g)?.details.num_rows);Lt(Se,{class:"fixed bottom-0 left-0 right-0 w-full bg-gray-800 p-4 text-white",get uploadTime(){return h(Ee)},get numColumns(){return h(Te)},get numRows(){return h(Re)}}),k(W),D(r,W),Z()}export{Ht as component};
