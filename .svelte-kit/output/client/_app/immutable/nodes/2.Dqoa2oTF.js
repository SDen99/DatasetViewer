import{a as D,t as C,c as ue}from"../chunks/disclose-version.xvGZuHic.js";import{v as N,B as re,x as Ne,C as Ae,m as We,M as Me,ak as ke,P as Ue,Q as ce,R as ae,w as H,N as be,o as xe,O as Fe,ar as se,z as fe,as as Qe,at as Ve,au as Be,a7 as Ye,G as ve,av as qe,aw as ze,aj as Ge,ax as He,q as $e,y as Ke,ag as Xe,ae as je,ay as Je,L as he,az as Ze,aA as et,l as A,j as x,k as w,p as j,i as J,t as Q,g as h,h as me,aB as ge,aC as tt,aD as rt,I as _e,$ as F}from"../chunks/runtime.DoilE01P.js";import{p as R,i as U,o as at,b as st}from"../chunks/index-client.Cd-buOrY.js";import{i as Z}from"../chunks/lifecycle.bMlwBbrJ.js";import{e as W,a as q,s as nt,b as $}from"../chunks/store.DDH_-z5m.js";import{w as Y}from"../chunks/index.DFqX7hCa.js";let ne=null;function K(r,e){return e}function ot(r,e,t,a){for(var s=[],i=e.length,n=0;n<i;n++)ze(e[n].e,s,!0);var _=i>0&&s.length===0&&t!==null;if(_){var p=t.parentNode;Ge(p),p.append(t),a.clear(),M(r,e[0].prev,e[i-1].next)}He(s,()=>{for(var o=0;o<i;o++){var v=e[o];_||(a.delete(v.k),M(r,v.prev,v.next)),$e(v.e,!_)}})}function X(r,e,t,a,s,i=null){var n=r,_={flags:e,items:new Map,first:null};{var p=r;n=N?re(Ke(p)):p.appendChild(Ne())}N&&Ae();var o=null,v=!1;We(()=>{var d=t(),u=Me(d)?d:d==null?[]:ke(d),c=u.length;if(v&&c===0)return;v=c===0;let f=!1;if(N){var m=n.data===Ue;m!==(c===0)&&(n=ce(),re(n),ae(!1),f=!0)}if(N){for(var l=null,g,S=0;S<c;S++){if(H.nodeType===8&&H.data===Xe){n=H,f=!0,ae(!1);break}var b=u[S],y=a(b,S);g=Ee(H,_,l,null,b,y,S,s,e),_.items.set(y,g),l=g}c>0&&re(ce())}N||lt(u,_,n,s,e,a),i!==null&&(c===0?o?be(o):o=xe(()=>i(n)):o!==null&&Fe(o,()=>{o=null})),f&&ae(!0),t()}),N&&(n=H)}function lt(r,e,t,a,s,i){var n=r.length,_=e.items,p=e.first,o=p,v,d=null,u=[],c=[],f,m,l,g;for(g=0;g<n;g+=1){if(f=r[g],m=i(f,g),l=_.get(m),l===void 0){var S=o?o.e.nodes_start:t;d=Ee(S,e,d,d===null?e.first:d.next,f,m,g,a,s),_.set(m,d),u=[],c=[],o=d.next;continue}if(it(l,f,g),l.e.f&se&&be(l.e),l!==o){if(v!==void 0&&v.has(l)){if(u.length<c.length){var b=c[0],y;d=b.prev;var E=u[0],L=u[u.length-1];for(y=0;y<u.length;y+=1)pe(u[y],b,t);for(y=0;y<c.length;y+=1)v.delete(c[y]);M(e,E.prev,L.next),M(e,d,E),M(e,L,b),o=b,d=L,g-=1,u=[],c=[]}else v.delete(l),pe(l,o,t),M(e,l.prev,l.next),M(e,l,d===null?e.first:d.next),M(e,d,l),d=l;continue}for(u=[],c=[];o!==null&&o.k!==m;)o.e.f&se||(v??=new Set).add(o),c.push(o),o=o.next;if(o===null)continue;l=o}u.push(l),d=l,o=l.next}if(o!==null||v!==void 0){for(var P=v===void 0?[]:ke(v);o!==null;)o.e.f&se||P.push(o),o=o.next;var V=P.length;if(V>0){var z=n===0?t:null;ot(e,P,z,_)}}fe.first=e.first&&e.first.e,fe.last=d&&d.e}function it(r,e,t,a){Qe(r.v,e),r.i=t}function Ee(r,e,t,a,s,i,n,_,p){var o=ne;try{var v=(p&Ve)!==0,d=(p&Be)===0,u=v?d?Ye(s):ve(s):s,c=p&qe?ve(n):n,f={i:c,v:u,k:i,a:null,e:null,prev:t,next:a};return ne=f,f.e=xe(()=>_(r,u,c),N),f.e.prev=t&&t.e,f.e.next=a&&a.e,t===null?e.first=f:(t.next=f,t.e.next=f.e),a!==null&&(a.prev=f,a.e.prev=f.e),f}finally{ne=o}}function pe(r,e,t){for(var a=r.next?r.next.e.nodes_start:t,s=e?e.e.nodes_start:t,i=r.e.nodes_start;i!==a;){var n=je(i);s.before(i),i=n}}function M(r,e,t){e===null?r.first=t:(e.next=t,e.e.next=t&&t.e),t!==null&&(t.prev=e,t.e.prev=e&&e.e)}let we=!1;function dt(){we||(we=!0,document.addEventListener("reset",r=>{Promise.resolve().then(()=>{if(!r.defaultPrevented)for(const e of r.target.elements)e.__on_r?.()})},{capture:!0}))}function ut(r){if(N){var e=!1,t=()=>{if(!e){if(e=!0,r.hasAttribute("value")){var a=r.value;oe(r,"value",null),r.value=a}if(r.hasAttribute("checked")){var s=r.checked;oe(r,"checked",null),r.checked=s}}};r.__on_r=t,Je(t),dt()}}function ct(r,e){var t=r.__attributes??={};t.value===(t.value=e)||r.value===e&&(e!==0||r.nodeName!=="PROGRESS")||(r.value=e)}function ft(r,e){var t=r.__attributes??={};t.checked!==(t.checked=e)&&(r.checked=e)}function oe(r,e,t,a){var s=r.__attributes??={};N&&(s[e]=r.getAttribute(e),e==="src"||e==="srcset"||e==="href"&&r.nodeName==="LINK")||s[e]!==(s[e]=t)&&(e==="style"&&"__styles"in r&&(r.__styles={}),e==="loading"&&(r[Ze]=t),t==null?r.removeAttribute(e):typeof t!="string"&&vt(r).includes(e)?r[e]=t:r.setAttribute(e,t))}var ye=new Map;function vt(r){var e=ye.get(r.nodeName);if(e)return e;ye.set(r.nodeName,e=[]);for(var t,a=he(r),s=Element.prototype;s!==a;){t=et(a);for(var i in t)t[i].set&&e.push(i);a=he(a)}return e}function ht(r,e){var t=r.__className,a=mt(e);N&&r.className===a?r.__className=a:(t!==a||N&&r.className!==a)&&(e==null?r.removeAttribute("class"):r.className=a,r.__className=a)}function mt(r){return r??""}var gt=C('<div class="flex items-center justify-center space-x-2"><div class="h-8 w-8 animate-spin rounded-full border-4 border-dashed border-white"></div> <div>Loading...</div></div>'),_t=C('<nav class="w-full bg-blue-500 p-4 text-white"><h1 class="text-2xl font-bold">Upload .sas7bdat Files</h1> <input type="file" accept=".sas7bdat" multiple class="mb-4 rounded border border-gray-300 p-2"> <!></nav>');function pt(r,e){let t=R(e,"handleFileChangeEvent",8),a=R(e,"isLoading",8);var s=_t(),i=A(x(s),2),n=A(i,2);U(n,a,_=>{var p=gt();D(_,p)}),w(s),W("change",i,function(..._){t()?.apply(this,_)}),D(r,s)}var wt=C('<li><button type="button"> </button></li>'),yt=C('<ul class="pl-5"></ul>'),kt=C('<p class="text-gray-500">No datasets to display.</p>'),bt=C('<aside class="w-1/4 bg-white p-4 shadow-md"><h2 class="mb-4 text-xl font-bold">Datasets</h2> <!></aside>');function xt(r,e){j(e,!1);let t=R(e,"datasets",8),a=R(e,"selectedDataset",8),s=R(e,"onSelectDataset",8);Z();var i=bt(),n=A(x(i),2);U(n,()=>t().size>0,_=>{var p=yt();X(p,5,()=>Array.from(t().keys()),K,(o,v)=>{var d=wt(),u=x(d),c=x(u,!0);w(u),w(d),Q(()=>{ht(u,`cursor-pointer text-gray-700 ${(h(v)===a()?"bg-red-500 text-white":"")??""}`),q(c,h(v))}),W("click",u,()=>s()(h(v))),D(o,d)}),w(p),D(_,p)},_=>{var p=kt();D(_,p)}),w(i),D(r,i),J()}var Et=C('<th draggable="true" class="cursor-move border-b border-gray-200 bg-gray-100 px-4 py-2 text-left text-sm font-semibold text-gray-700 hover:bg-gray-200"> </th>'),Dt=C('<td class="border-b border-gray-200 px-4 py-2 text-sm text-gray-700"> </td>'),St=C("<tr></tr>"),Tt=C('<table class="min-w-full bg-white"><thead><tr></tr></thead><tbody></tbody></table>');function Rt(r,e){j(e,!1);let t=R(e,"data",8),a=R(e,"selectedColumns",8),s=R(e,"columnOrder",8),i=R(e,"onReorderColumns",8),n=null;function _(m,l){n=l,m.dataTransfer&&(m.dataTransfer.effectAllowed="move",m.dataTransfer.setData("text/plain",l))}function p(m){m.preventDefault(),m.dataTransfer&&(m.dataTransfer.dropEffect="move")}function o(m,l){if(m.preventDefault(),!n||n===l)return;const g=[...s()],S=g.indexOf(n),b=g.indexOf(l);g.splice(S,1),g.splice(b,0,n),i()(g),n=null}function v(m){return a().has(m)}Z();var d=Tt(),u=x(d),c=x(u);X(c,5,s,K,(m,l)=>{var g=ue(),S=me(g);U(S,()=>v(h(l)),b=>{var y=Et(),E=x(y,!0);w(y),Q(()=>q(E,h(l))),W("dragstart",y,L=>_(L,h(l))),W("dragover",y,p),W("drop",y,L=>o(L,h(l))),D(b,y)}),D(m,g)}),w(c),w(u);var f=A(u);X(f,5,()=>t().slice(0,10),K,(m,l)=>{var g=St();X(g,5,s,K,(S,b)=>{var y=ue(),E=me(y);U(E,()=>v(h(b)),L=>{var P=Dt(),V=x(P,!0);w(P),Q(()=>q(V,h(l)[h(b)])),D(L,P)}),D(S,y)}),w(g),D(m,g)}),w(f),w(d),D(r,d),J()}var Ct=C('<li draggable="true" class="cursor-move py-1 hover:bg-gray-100"><label class="flex items-center space-x-2"><input type="checkbox"> <span> </span></label></li>'),Ot=C('<aside class="w-1/4 bg-white p-4 shadow-md"><h2 class="mb-4 text-xl font-bold">Variables</h2> <ul class="pl-5"></ul></aside>');function Lt(r,e){j(e,!1);let t=R(e,"selectedColumns",8),a=R(e,"columnOrder",8),s=R(e,"onColumnToggle",8),i=R(e,"onReorderVariables",8),n=null;function _(u,c){n=c,u.dataTransfer&&(u.dataTransfer.effectAllowed="move",u.dataTransfer.setData("text/plain",c))}function p(u){u.preventDefault(),u.dataTransfer&&(u.dataTransfer.dropEffect="move")}function o(u,c){if(u.preventDefault(),!n||n===c)return;const f=[...a()],m=f.indexOf(n),l=f.indexOf(c);f.splice(m,1),f.splice(l,0,n),i()(f),n=null}Z();var v=Ot(),d=A(x(v),2);X(d,5,a,K,(u,c)=>{var f=Ct(),m=x(f),l=x(m);ut(l),Q(()=>ft(l,t().has(h(c))));var g=A(l,2),S=x(g,!0);w(g),w(m),w(f),Q(()=>{oe(l,"name",h(c)),ct(l,h(c)),q(S,h(c))}),W("change",l,b=>s()(h(c),b.target.checked)),W("dragstart",f,b=>_(b,h(c))),W("dragover",f,p),W("drop",f,b=>o(b,h(c))),D(u,f)}),w(d),w(v),D(r,v),J()}var It=C('<p class="text-sm"> </p>'),Pt=C('<p class="text-sm"> </p>'),Nt=C('<footer class="flex w-full items-center justify-between bg-gray-800 p-4 text-white"><div><!></div> <div><!></div></footer>');function At(r,e){let t=R(e,"uploadTime",8),a=R(e,"numColumns",8),s=R(e,"numRows",8);console.log(t(),a(),s());var i=Nt(),n=x(i),_=x(n);U(_,()=>t()!==void 0,v=>{var d=It(),u=x(d);w(d),Q(()=>q(u,`Upload and processing time: ${t()??""} seconds`)),D(v,d)}),w(n);var p=A(n,2),o=x(p);U(o,()=>a()!==void 0&&s()!==void 0,v=>{var d=Pt(),u=x(d);w(d),Q(()=>q(u,`Variables: ${a()??""}
				Records: ${s()??""}`)),D(v,d)}),w(p),w(i),D(r,i)}function Wt(r){return`/_app/${r}`}class De{workers=[];taskQueue=[];maxWorkers;idleTimeout;workerURL;constructor(e=Math.max(1,navigator.hardwareConcurrency-1),t=3e4){this.maxWorkers=e,this.idleTimeout=t,this.workerURL=Wt("fileProcessor.worker.ts"),setInterval(()=>this.cleanupIdleWorkers(),1e4)}createWorker(){return new Promise((e,t)=>{try{const a=new Worker(new URL(""+new URL("../workers/fileProcessor.worker-C2cELnqq.js",import.meta.url).href,import.meta.url),{type:"module"}),s={worker:a,busy:!1,lastUsed:Date.now(),pyodideReady:!1},i=n=>{n.data.type==="PYODIDE_READY"?(s.pyodideReady=!0,a.removeEventListener("message",i),e(s)):n.data.type==="PYODIDE_ERROR"&&(a.removeEventListener("message",i),t(new Error(n.data.error)))};a.addEventListener("message",i),a.addEventListener("error",n=>{console.error("Worker creation error:",n),t(n)}),a.onmessage=n=>this.handleWorkerMessage(n,s)}catch(a){console.error("Failed to create worker:",a),t(a)}})}async getAvailableWorker(){let e=this.workers.find(t=>!t.busy&&t.pyodideReady);if(!e&&this.workers.length<this.maxWorkers)try{e=await this.createWorker(),this.workers.push(e)}catch(t){throw console.error("Failed to create worker:",t),t}return e||new Promise(t=>{const a=setInterval(()=>{const s=this.workers.find(i=>!i.busy&&i.pyodideReady);s&&(clearInterval(a),t(s))},100)})}handleWorkerMessage(e,t){const a=this.taskQueue.find(s=>s.id===e.data.taskId);a&&(e.data.type==="PROCESSING_COMPLETE"?a.resolve(e.data.result):e.data.type==="PROCESSING_ERROR"&&a.reject(new Error(e.data.error)),t.busy=!1,t.lastUsed=Date.now(),this.taskQueue=this.taskQueue.filter(s=>s.id!==e.data.taskId),this.processNextTask())}handleWorkerError(e,t){console.error("Worker error:",e),t.busy=!1}async processNextTask(){if(this.taskQueue.length!==0)try{const e=await this.getAvailableWorker(),t=this.taskQueue[0];e.busy=!0,e.lastUsed=Date.now(),e.worker.postMessage({type:"PROCESS_FILE",taskId:t.id,file:t.file,fileName:t.fileName})}catch(e){console.error("Failed to process task:",e),this.taskQueue[0].reject(e),this.taskQueue.shift()}}cleanupIdleWorkers(){const e=Date.now();this.workers=this.workers.filter(t=>!t.busy&&e-t.lastUsed>this.idleTimeout?(t.worker.terminate(),!1):!0)}async processFile(e,t){return new Promise((a,s)=>{const i={id:`task_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,file:e,fileName:t,resolve:a,reject:s};this.taskQueue.push(i),this.processNextTask()})}terminate(){this.workers.forEach(e=>{e.worker.terminate()}),this.workers=[],this.taskQueue=[]}}new De;async function Mt(){if(typeof loadPyodide>"u")throw new Error("loadPyodide is not defined. Ensure Pyodide is correctly loaded.");return loadPyodide({indexURL:"https://cdn.jsdelivr.net/pyodide/v0.18.1/full/"})}var Ut=C('<main class="flex min-h-screen flex-col bg-gray-100"><!> <div class="flex flex-1 overflow-hidden"><!> <section class="flex-1 overflow-x-auto p-4"><!></section> <!></div> <!></main>');function zt(r,e){j(e,!1);const t=nt(),a=()=>$(d,"$selectedDatasetStore",t),s=()=>$(v,"$datasetsStore",t),i=()=>$(u,"$isLoadingStore",t),n=()=>$(f,"$selectedColumnsStore",t),_=()=>$(m,"$columnOrderStore",t);let p=null,o=!1;const v=Y(new Map),d=Y(null),u=Y(!1),c=Y(null),f=Y(new Map),m=Y(new Map),l=new De;function g(k){u.set(k)}function S(k){c.set(k)}at(async()=>{if(!o)try{console.log("Initializing Pyodide..."),p=Mt(),await p,o=!0,console.log("Pyodide loaded successfully")}catch(k){console.error("Error loading Pyodide:",k)}}),st(()=>{l.terminate()});async function b(k){const T=k.target.files;if(!T||T.length===0)return;g(!0);const O=performance.now(),B=[];try{for(const G of T){if(!G.name.endsWith(".sas7bdat")){console.warn(`Skipping ${G.name} - not a SAS file`);continue}const Ie=await G.arrayBuffer(),Pe=l.processFile(Ie,G.name).then(ie=>(v.update(de=>(de.set(G.name,{...ie,processingTime:(performance.now()-O)/1e3}),de)),ie));B.push(Pe)}await Promise.all(B);const te=(performance.now()-O)/1e3;S(te)}catch(te){console.error("Error processing files:",te)}finally{g(!1)}}function y(k,I){f.update(T=>{const O=a();if(O){let B=T.get(O)||new Set;I?B.add(k):B.delete(k),T.set(O,B)}return T})}let E=rt(null);function L(k){const I=a();I&&m.update(T=>(T.set(I,k),T))}ge(()=>(a(),s()),()=>{a()?_e(E,s().get(a())):_e(E,null)}),ge(()=>(h(E),a()),()=>{if(h(E)){const k=a();if(k){const I=Object.keys(h(E).data[0]||{}),T=new Set(I.slice(0,5));f.update(O=>(O.set(k,T),O)),m.update(O=>(O.has(k)||O.set(k,I),O))}}}),tt(),Z();var P=Ut(),V=x(P);pt(V,{handleFileChangeEvent:b,get isLoading(){return i()}});var z=A(V,2),le=x(z);xt(le,{get datasets(){return s()},get selectedDataset(){return a()},onSelectDataset:k=>d.set(k)});var ee=A(le,2),Se=x(ee);U(Se,()=>h(E),k=>{var I=F(()=>a()?n().get(a())??new Set:new Set),T=F(()=>a()?_().get(a())??[]:[]);Rt(k,{get data(){return h(E).data},get selectedColumns(){return h(I)},get columnOrder(){return h(T)},onReorderColumns:L})}),w(ee);var Te=A(ee,2);U(Te,()=>h(E),k=>{var I=F(()=>a()?n().get(a())??new Set:new Set),T=F(()=>a()?_().get(a())??[]:[]);Lt(k,{get variables(){return h(E).details.columns},get selectedColumns(){return h(I)},get columnOrder(){return h(T)},onColumnToggle:y,onReorderVariables:L})}),w(z);var Re=A(z,2),Ce=F(()=>h(E)?.processingTime.toFixed(2)),Oe=F(()=>h(E)?.details.num_columns),Le=F(()=>h(E)?.details.num_rows);At(Re,{class:"fixed bottom-0 left-0 right-0 w-full bg-gray-800 p-4 text-white",get uploadTime(){return h(Ce)},get numColumns(){return h(Oe)},get numRows(){return h(Le)}}),w(P),D(r,P),J()}export{zt as component};
